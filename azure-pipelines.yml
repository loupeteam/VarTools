# This workflow will run build an AS project and save the libraries to a pipeline artifact
trigger:
  branches:
    include:
      - main
  tags:
    include:
      - v*

jobs:
- job: build_publish_libraries
  pool:
    name: 'AutomationStudioPool'
  steps:
  - checkout: self
    clean: true
    fetchDepth: 0
    fetchTags: true
    lfs: true
    persistCredentials: true
    submodules: recursive
    path: "main"
    displayName: 'Checkout repository'

  - script: python.exe C:/Tools/AsPython/InstallUpgrades.py $(Build.SourcesDirectory)/upgrades -asp AS411 -r --logLevel DEBUG
    displayName: 'Install AS upgrades'

  - script: python.exe C:/Tools/AsPython/CmdLineBuild.py $(Build.SourcesDirectory)/example/AsProject/AsProject.apj -c Intel ARM -bm Rebuild -sim --logLevel DEBUG
    displayName: 'Build project'

  - script: python.exe C:/Tools/AsPython/CmdLineExportLib.py $(Build.SourcesDirectory)/example/AsProject/AsProject.apj -dest ./libs -c Intel ARM -wl vartools -l DEBUG -o -bm "None"
    displayName: 'Export libraries'

  - task: PublishBuildArtifacts@1
    inputs:
      pathToPublish: '$(Pipeline.Workspace)/main/libs/vartools'
      artifactName: 'vartools'